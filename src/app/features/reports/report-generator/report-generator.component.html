<div class="bg-white rounded-xl shadow-xl p-8 max-w-5xl mx-auto mt-10">
  <h2 class="text-2xl font-bold text-center text-slate-800 mb-4">
    Generador de Reportes
  </h2>
  <p class="text-gray-600 text-center mb-8">
    Selecciona los gráficos que deseas incluir en el reporte PDF.
  </p>

  <!-- Botón abrir filtros -->
  <div class="flex justify-center mb-6">
    <button (click)="openFilterSidebar()" class="bg-gray-100 px-4 py-2 rounded-lg border">
      Abrir filtros
    </button>
  </div>
  <!-- Overlay y panel lateral como en Dashboard -->
  <div
    *ngIf="isFilterSidebarOpen"
    (click)="closeFilterSidebar()"
    class="fixed inset-0 bg-black/50 z-40 transition-opacity duration-300"
    [ngClass]="{ 'opacity-100': isFilterSidebarOpen, 'opacity-0 pointer-events-none': !isFilterSidebarOpen }"
  >
  </div>

  <div
    class="fixed top-0 right-0 h-full w-80 md:w-96 bg-white z-50 shadow-2xl transition-transform duration-300 ease-in-out"
    [ngClass]="{ 'translate-x-0': isFilterSidebarOpen, 'translate-x-full': !isFilterSidebarOpen }"
    (click)="$event.stopPropagation()"
    [attr.aria-hidden]="!isFilterSidebarOpen"
  >
    <app-filter-sidebar
      [questions]="surveyQuestions"
      (close)="closeFilterSidebar()"
      (filtersApplied)="onAnswerFiltersApplied($event)"
    >
    </app-filter-sidebar>
  </div>

  <!-- KPIs principales -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
    <app-kpi-card
      title="Encuestas"
      [value]="kpisGenerales?.totalEncuestas ?? 'N/A'"
      description="Total de encuestas"
      iconClass="fas fa-poll"
    ></app-kpi-card>

    <app-kpi-card
      title="Municipios"
      [value]="municipiosCubiertos"
      description="Municipios cubiertos"
      iconClass="fas fa-city"
    ></app-kpi-card>

    <app-kpi-card
      title="Distritos"
      [value]="distritosLocalesCubiertos"
      description="Distritos cubiertos"
      iconClass="fas fa-map"
    ></app-kpi-card>
  </div>

  <!-- Opciones de selección -->
  <div class="flex flex-wrap justify-center gap-4 mb-6">
    <label
      *ngFor="let grafico of graficos"
      class="flex items-center gap-2 bg-slate-50 hover:bg-slate-100 px-4 py-2 rounded-lg border border-slate-200 cursor-pointer"
    >
      <input
        type="radio"
        name="chartType"
        [(ngModel)]="selectedGraficoId"
        [value]="grafico.id"
        class="accent-[#E71D36] w-4 h-4"
      />
      <span class="font-medium text-slate-700">{{ grafico.nombre }}</span>
    </label>
  </div>

  <!-- Contenedor de gráficos (solo los 4 tipos solicitados) -->
  <div id="report-content" class="space-y-10">

    <!-- GAUGE (semicircular) -->
    <div id="chart-gauge" *ngIf="isSelected('gauge')" class="border rounded-lg p-4 shadow">
      <h3 class="text-lg font-semibold text-slate-700 mb-2">Gráfico semicircular</h3>
      <!-- Usamos 'sexo' como ejemplo de datos proporcionales -->
      <app-gauge-chart title="Proporción" description="Ejemplo" [data]="questionResults['sexo']"></app-gauge-chart>
    </div>

    <!-- HORIZONTAL BAR -->
    <div id="chart-hbar" *ngIf="isSelected('hbar')" class="border rounded-lg p-4 shadow">
      <h3 class="text-lg font-semibold text-slate-700 mb-2">Gráfico de barras horizontales</h3>
      <!-- Usamos 'politicosHombres' como ejemplo -->
      <app-bar-chart title="Barras horizontales" description="Ejemplo" [data]="questionResults['politicosHombres']"></app-bar-chart>
    </div>

    <!-- VERTICAL BAR -->
    <div id="chart-vbar" *ngIf="isSelected('vbar')" class="border rounded-lg p-4 shadow">
      <h3 class="text-lg font-semibold text-slate-700 mb-2">Gráfico de barras verticales</h3>
      <!-- Usamos 'rangoEdad' como ejemplo -->
      <app-vertical-bar-chart title="Barras verticales" description="Ejemplo" [data]="questionResults['rangoEdad']"></app-vertical-bar-chart>
    </div>

    <!-- PIE / DOUGHNUT -->
    <div id="chart-pie" *ngIf="isSelected('pie')" class="border rounded-lg p-4 shadow">
      <h3 class="text-lg font-semibold text-slate-700 mb-2">Gráfico de pastel / dona</h3>
      <!-- Usamos 'demografia' como ejemplo -->
      <app-pie-chart title="Pie/Dona" description="Ejemplo" [data]="questionResults['demografia']"></app-pie-chart>
    </div>

  </div>

  <!-- Botón Generar PDF -->
  <div class="flex justify-center mt-10">
    <button
      (click)="generatePDF()"
      [disabled]="(isGeneratingPdf || false)"
      class="bg-[#E71D36] text-white px-6 py-3 rounded-lg hover:bg-[#C4172D] transition flex items-center gap-2"
    >
      <span *ngIf="isGeneratingPdf" class="animate-spin mr-2">⏳</span>
      <i class="fas fa-file-pdf"></i>
      Generar Reporte PDF
    </button>
  </div>
  <!-- Área temporal para renderizar charts que se capturan para el PDF -->
  <div *ngIf="renderChartsForPdf" class="fixed inset-0 bg-white/95 z-50 overflow-auto p-6">
    <div *ngFor="let q of pdfQuestions" class="mb-6">
      <!-- Reduced size for temporary render to avoid memory spikes -->
      <div id="chart-question-{{q.id_pregunta}}" style="width:720px;height:320px;margin:0 auto;padding:6px;background:#fff;border:1px solid #eee;">
        <ng-container [ngSwitch]="getChartTypeForQuestion(q.id_pregunta)">
          <app-gauge-chart *ngSwitchCase="'gauge'" [data]="mapToChartData(q.id_pregunta)"></app-gauge-chart>
          <app-pie-chart *ngSwitchCase="'pie'" [data]="mapToChartData(q.id_pregunta)"></app-pie-chart>
          <app-vertical-bar-chart *ngSwitchCase="'vbar'" [data]="mapToChartData(q.id_pregunta)"></app-vertical-bar-chart>
          <app-bar-chart *ngSwitchDefault [data]="mapToChartData(q.id_pregunta)"></app-bar-chart>
        </ng-container>
      </div>
    </div>
  </div>
</div>
