<div class="bg-background p-6 space-y-6">
  <h1 class="text-2xl font-semibold text-slate-800">
    Dashboard Electoral Tlaxcala
  </h1>

  <div class="bg-background-paper shadow-md rounded-lg p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold text-slate-700">Filtros</h2>
      <div *ngIf="isLoadingFilters" class="text-secondary-dark text-sm">
        Cargando opciones...
      </div>
      <button
        (click)="resetFilters()"
        [disabled]="isLoading || isLoadingFilters"
        class="inline-flex items-center px-3 py-1.5 border border-secondary-light shadow-sm text-xs font-medium rounded-md text-slate-700 bg-background-paper hover:bg-slate-50 disabled:opacity-50 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-primary"
      >
        Limpiar Filtros
      </button>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4">
      <div>
        <label
          for="estado-select"
          class="block text-xs font-medium text-secondary-dark"
          >Estado</label
        >
        <select
          id="estado-select"
          [(ngModel)]="currentFilters.id_estado"
          (change)="onEstadoChange()"
          [disabled]="isLoadingFilters || estados.length <= 1"
          class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-secondary-light rounded-md focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary disabled:bg-slate-100 disabled:text-secondary-dark"
        >
          <option [value]="'all'" [disabled]="estados.length === 1">
            Todos
          </option>
          <option *ngFor="let estado of estados" [value]="estado.id">
            {{ estado.nombre }}
          </option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-secondary-dark"
          >Distrito Federal</label
        >
        <select
          [(ngModel)]="currentFilters.id_distrito_federal"
          (change)="onFederalDistrictChange()"
          [disabled]="isLoadingFilters || currentFilters.id_estado === 'all'"
          class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-secondary-light rounded-md focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary disabled:bg-slate-100 disabled:text-secondary-dark"
        >
          <option [value]="'all'">Todos</option>
          <option *ngFor="let df of distritosFederales" [value]="df.id">
            {{ df.nombre }}
          </option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-secondary-dark"
          >Distrito Local</label
        >
        <select
          [(ngModel)]="currentFilters.id_distrito_local"
          (change)="onLocalDistrictChange()"
          [disabled]="
            isLoadingFilters || currentFilters.id_distrito_federal === 'all'
          "
          class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-secondary-light rounded-md focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary disabled:bg-slate-100 disabled:text-secondary-dark"
        >
          <option [value]="'all'">Todos</option>
          <option *ngFor="let dl of distritosLocales" [value]="dl.id">
            {{ dl.nombre }}
          </option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-secondary-dark"
          >Municipio</label
        >
        <select
          [(ngModel)]="currentFilters.id_municipio"
          (change)="onMunicipioChange()"
          [disabled]="
            isLoadingFilters || currentFilters.id_distrito_local === 'all'
          "
          class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-secondary-light rounded-md focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary disabled:bg-slate-100 disabled:text-secondary-dark"
        >
          <option [value]="'all'">Todos</option>
          <option *ngFor="let municipio of municipios" [value]="municipio.id">
            {{ municipio.nombre }}
          </option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-secondary-dark"
          >Sección</label
        >
        <select
          [(ngModel)]="currentFilters.id_seccion"
          (change)="onSeccionChange()"
          [disabled]="isLoadingFilters || currentFilters.id_municipio === 'all'"
          class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-secondary-light rounded-md focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary disabled:bg-slate-100 disabled:text-secondary-dark"
        >
          <option [value]="'all'">Todas</option>
          <option *ngFor="let seccion of secciones" [value]="seccion.id">
            {{ seccion.nombre }}
          </option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-secondary-dark"
          >Comunidad</label
        >
        <select
          [(ngModel)]="currentFilters.id_comunidad"
          (change)="onComunidadChange()"
          [disabled]="isLoadingFilters || currentFilters.id_seccion === 'all'"
          class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-secondary-light rounded-md focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary disabled:bg-slate-100 disabled:text-secondary-dark"
        >
          <option [value]="'all'">Todas</option>
          <option *ngFor="let comunidad of comunidades" [value]="comunidad.id">
            {{ comunidad.nombre }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <div
    *ngIf="isLoading || isLoadingQuestions"
    class="text-center text-lg text-secondary-dark my-6"
  >
    Cargando datos...
  </div>

  <ng-container *ngIf="!isLoading && !isLoadingQuestions">
    <div *ngIf="kpisGenerales as kpis" class="space-y-6">
      <div>
        <h2 class="text-base font-semibold text-slate-700 mb-3">
          Resumen General
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <app-kpi-card
            title="Encuestas"
            [value]="kpis.totalEncuestas ?? 0"
            description="Total realizadas"
            iconClass="fas fa-poll"
          ></app-kpi-card>
          <ng-container
            *ngIf="
              kpis.participacionGenero && kpis.participacionGenero.length > 0
            "
          >
            <app-kpi-card
              *ngFor="let genero of kpis.participacionGenero"
              [title]="genero.genero"
              [value]="genero.total"
              description="Participación"
              iconClass="fas fa-users"
            ></app-kpi-card>
          </ng-container>
        </div>
      </div>

      <div>
        <h2 class="text-base font-semibold text-slate-700 mb-2">
          Análisis Geográfico
        </h2>
        <div class="bg-background-paper shadow-md rounded-lg p-4 h-[400px]">
          <app-heatmap-map [data]="ubicaciones ?? []"></app-heatmap-map>
          <div
            *ngIf="!ubicaciones || ubicaciones.length === 0"
            class="flex items-center justify-center h-full text-secondary-dark text-sm"
          >
            No hay datos geográficos.
          </div>
        </div>
      </div>

      <div class="space-y-4">
        <h2 class="text-lg font-semibold text-slate-700">
          Resultados por Pregunta
        </h2>

        <div *ngIf="isLoadingQuestions" class="text-center text-secondary-dark">
          Cargando resultados...
        </div>

        <div
          *ngIf="!isLoadingQuestions && surveyQuestions.length > 0"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-stretch"
        >
          <ng-container *ngFor="let question of surveyQuestions">
            <ng-container
              *ngIf="questionResults[question.id_pregunta] as results"
            >
              <div *ngIf="results.length > 0">
                <ng-container *ngIf="results.length === 2; else otherCharts">
                  <app-gauge-chart
                    [title]="question.texto_pregunta"
                    description="Proporción"
                    [data]="results"
                  ></app-gauge-chart>
                </ng-container>
                <ng-template #otherCharts>
                  <div
                    *ngIf="
                      results.length > 2 && results.length <= 6;
                      else barChartBlock
                    "
                  >
                    <app-pie-chart
                      [title]="question.texto_pregunta"
                      description="Distribución"
                      [data]="results"
                    ></app-pie-chart>
                  </div>
                  <ng-template #barChartBlock>
                    <app-bar-chart
                      [title]="question.texto_pregunta"
                      description="Distribución"
                      [data]="results"
                    ></app-bar-chart>
                  </ng-template>
                </ng-template>
              </div>
            </ng-container>
          </ng-container>
        </div>

        <div
          *ngIf="!isLoadingQuestions && surveyQuestions.length === 0"
          class="text-center text-secondary-dark"
        >
          No hay preguntas disponibles.
        </div>
      </div>
    </div>
  </ng-container>

  <div
    *ngIf="!isLoading && !isLoadingQuestions && !kpisGenerales"
    class="text-center text-lg text-secondary-dark my-8"
  >
    Selecciona filtros para ver los datos del dashboard.
  </div>
</div>

<ng-template #noDataTemplate
  ><p class="text-secondary-dark text-xs text-center py-2">
    No hay datos.
  </p></ng-template
>
<ng-template #noDataPrefTemplate
  ><p class="text-secondary-dark text-xs text-center py-4">
    No hay datos.
  </p></ng-template
>
