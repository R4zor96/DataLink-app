<div class="min-h-screen bg-slate-100 p-4 sm:p-6 lg:p-8">
  <div class="max-w-7xl mx-auto space-y-6">

    <h1 class="text-3xl font-bold text-brand-red mb-6">
      Dashboard Electoral Tlaxcala
    </h1>

    <div class="bg-white shadow-md rounded-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-slate-700">Filtros</h2>
        <div *ngIf="isLoadingFilters" class="text-slate-500 text-sm">Cargando opciones...</div>
        <button (click)="resetFilters()" [disabled]="isLoading || isLoadingFilters" class="inline-flex items-center px-3 py-1.5 border border-slate-300 shadow-sm text-xs font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-red disabled:opacity-50 disabled:cursor-not-allowed">
          Limpiar Filtros
        </button>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4">
        <div>
          <label for="estado-select" class="block text-xs font-medium text-slate-700">Estado</label>
          <select id="estado-select" [(ngModel)]="currentFilters.id_estado" (change)="onEstadoChange()" [disabled]="isLoadingFilters || estados.length <= 1" class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-gray-300 focus:outline-none focus:ring-brand-red focus:border-brand-red rounded-md disabled:bg-slate-100 disabled:cursor-not-allowed">
            <option [value]="'all'" [disabled]="estados.length === 1">Todos</option>
            <option *ngFor="let estado of estados" [value]="estado.id">{{ estado.nombre }}</option>
          </select>
        </div>
        <div>
          <label for="df-select" class="block text-xs font-medium text-slate-700">Distrito Federal</label>
          <select id="df-select" [(ngModel)]="currentFilters.id_distrito_federal" (change)="onFederalDistrictChange()" [disabled]="isLoadingFilters || currentFilters.id_estado === 'all'" class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-gray-300 focus:outline-none focus:ring-brand-red focus:border-brand-red rounded-md disabled:bg-slate-100 disabled:cursor-not-allowed">
            <option [value]="'all'">Todos</option>
            <option *ngFor="let df of distritosFederales" [value]="df.id">{{ df.nombre }}</option>
          </select>
        </div>
        <div>
          <label for="dl-select" class="block text-xs font-medium text-slate-700">Distrito Local</label>
          <select id="dl-select" [(ngModel)]="currentFilters.id_distrito_local" (change)="onLocalDistrictChange()" [disabled]="isLoadingFilters || currentFilters.id_distrito_federal === 'all'" class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-gray-300 focus:outline-none focus:ring-brand-red focus:border-brand-red rounded-md disabled:bg-slate-100 disabled:cursor-not-allowed">
            <option [value]="'all'">Todos</option>
            <option *ngFor="let dl of distritosLocales" [value]="dl.id">{{ dl.nombre }}</option>
          </select>
        </div>
        <div>
          <label for="municipio-select" class="block text-xs font-medium text-slate-700">Municipio</label>
          <select id="municipio-select" [(ngModel)]="currentFilters.id_municipio" (change)="onMunicipioChange()" [disabled]="isLoadingFilters || currentFilters.id_distrito_local === 'all'" class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-gray-300 focus:outline-none focus:ring-brand-red focus:border-brand-red rounded-md disabled:bg-slate-100 disabled:cursor-not-allowed">
            <option [value]="'all'">Todos</option>
            <option *ngFor="let municipio of municipios" [value]="municipio.id">{{ municipio.nombre }}</option>
          </select>
        </div>
        <div>
          <label for="seccion-select" class="block text-xs font-medium text-slate-700">Sección</label>
          <select id="seccion-select" [(ngModel)]="currentFilters.id_seccion" (change)="onSeccionChange()" [disabled]="isLoadingFilters || currentFilters.id_municipio === 'all'" class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-gray-300 focus:outline-none focus:ring-brand-red focus:border-brand-red rounded-md disabled:bg-slate-100 disabled:cursor-not-allowed">
            <option [value]="'all'">Todas</option>
            <option *ngFor="let seccion of secciones" [value]="seccion.id">{{ seccion.nombre }}</option>
          </select>
        </div>
        <div>
          <label for="comunidad-select" class="block text-xs font-medium text-slate-700">Comunidad</label>
          <select id="comunidad-select" [(ngModel)]="currentFilters.id_comunidad" (change)="onComunidadChange()" [disabled]="isLoadingFilters || currentFilters.id_seccion === 'all'" class="mt-1 block w-full pl-3 pr-8 py-1.5 text-sm border-gray-300 focus:outline-none focus:ring-brand-red focus:border-brand-red rounded-md disabled:bg-slate-100 disabled:cursor-not-allowed">
            <option [value]="'all'">Todas</option>
            <option *ngFor="let comunidad of comunidades" [value]="comunidad.id">{{ comunidad.nombre }}</option>
          </select>
        </div>
      </div>
    </div>

    <div *ngIf="isLoading" class="text-center text-lg text-slate-600 my-6">Cargando datos...</div>

    <ng-container *ngIf="!isLoading && kpisGenerales as kpis">
      <div class="space-y-6">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 space-y-4">
            <h2 class="text-lg font-semibold text-slate-800">Resumen General</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
              <app-kpi-card title="Encuestas" [value]="kpis.totalEncuestas ?? 0" description="Total realizadas" iconClass="fas fa-poll"></app-kpi-card>
              <app-kpi-card title="Municipios" [value]="kpis.cobertura?.municipios ?? 0" description="Cubiertos" iconClass="fas fa-city"></app-kpi-card>
              <app-kpi-card title="Dist. Locales" [value]="kpis.cobertura?.distritosLocales ?? 0" description="Cubiertos" iconClass="fas fa-map-marked-alt"></app-kpi-card>
              <ng-container *ngIf="kpis.participacionGenero">
                 <app-kpi-card *ngFor="let genero of kpis.participacionGenero" [title]="genero.genero" [value]="genero.total" description="Participación" iconClass="fas fa-users"></app-kpi-card>
              </ng-container>
            </div>
          </div>

          <div class="lg:col-span-1">
            <h2 class="text-lg font-semibold text-slate-800 mb-4">Preferencias</h2>
            <ng-container *ngIf="preferencias as prefs; else noDataPrefTemplate">
               <div class="bg-white shadow-md rounded-lg p-4 flex flex-col" style="height: calc(100% - 2.5rem);">
                 <div *ngIf="prefs.length > 0" class="text-slate-600 flex-grow min-h-0 overflow-y-auto pr-2 text-sm">
                   <ul class="space-y-1.5">
                     <li *ngFor="let item of prefs" class="flex justify-between border-b border-slate-200 pb-1">
                       <span>{{ item.candidato }}</span>
                       <span class="font-semibold text-slate-800">{{ item.total }}</span>
                     </li>
                   </ul>
                 </div>
                 <p *ngIf="prefs.length === 0" class="text-slate-500 text-xs text-center py-4">No hay datos.</p>
               </div>
            </ng-container>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 space-y-4">
            <h2 class="text-lg font-semibold text-slate-800">Análisis Geográfico</h2>
            <div class="bg-white shadow-md rounded-lg p-4 h-[500px]">
              <app-heatmap-map [data]="ubicaciones ?? []"></app-heatmap-map>
              <div *ngIf="!ubicaciones || ubicaciones.length === 0" class="flex items-center justify-center h-full text-slate-500 text-sm">
                No hay datos geográficos.
              </div>
            </div>
          </div>

          <div class="lg:col-span-1 space-y-4">
            <h2 class="text-lg font-semibold text-slate-800">Detalle Demográfico</h2>
            <ng-container *ngIf="graficosDemograficos as demo; else noDataTemplate">
              <div class="space-y-4">
                <div class="bg-white shadow-md rounded-lg p-4 text-sm">
                  <h3 class="font-semibold text-slate-800 mb-2">Edad</h3>
                  <div *ngIf="demo.distribucionEdad && demo.distribucionEdad.length > 0; else noDataTemplate" class="text-slate-600">
                    <ul class="space-y-1"><li *ngFor="let item of demo.distribucionEdad" class="flex justify-between border-b border-slate-200 py-0.5"><span>{{ item.rango }}</span><span class="font-semibold text-slate-800">{{ item.total }}</span></li></ul>
                  </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-4 text-sm">
                  <h3 class="font-semibold text-slate-800 mb-2">Escolaridad</h3>
                  <div *ngIf="(demo.nivelEscolaridad ?? []).length > 0; else noDataTemplate" class="text-slate-600">
                    <ul class="space-y-1"><li *ngFor="let item of demo.nivelEscolaridad" class="flex justify-between border-b border-slate-200 py-0.5"><span>{{ item.nivel }}</span><span class="font-semibold text-slate-800">{{ item.total }}</span></li></ul>
                  </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-4 text-sm">
                  <h3 class="font-semibold text-slate-800 mb-2">Ocupación</h3>
                  <div *ngIf="(demo.ocupacionPrincipal ?? []).length > 0; else noDataTemplate" class="text-slate-600">
                    <ul class="space-y-1"><li *ngFor="let item of demo.ocupacionPrincipal" class="flex justify-between border-b border-slate-200 py-0.5"><span>{{ item.ocupacion }}</span><span class="font-semibold text-slate-800">{{ item.total }}</span></li></ul>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #noDataTemplate><p class="text-slate-500 text-xs text-center py-2">No hay datos.</p></ng-template>
    <ng-template #noDataPrefTemplate><p class="text-slate-500 text-xs text-center py-4">No hay datos.</p></ng-template>

    <div *ngIf="!isLoading && !kpisGenerales" class="text-center text-lg text-slate-500 my-8">
      Selecciona filtros para ver los datos del dashboard.
    </div>
  </div>
</div>
